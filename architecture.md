# 鼠标轨迹收集器 - 改进的架构设计

## 架构概述

本文档描述了鼠标轨迹收集器系统的改进架构设计。新架构采用了分层设计、模块化组件和清晰的接口定义，提高了系统的可维护性、可扩展性和可测试性。

## 架构原则

1. **分层架构**: 清晰的层次划分，每层只依赖下层
2. **接口隔离**: 通过接口定义组件交互，降低耦合
3. **单一职责**: 每个模块只负责一个功能领域
4. **配置驱动**: 通过配置文件管理系统参数
5. **错误处理**: 统一的错误处理和日志记录机制

## 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                   应用层 (Application)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   收集器UI  │  │   播放器UI  │  │  命令行工具 │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 轨迹收集器  │  │ 轨迹生成器  │  │ 鼠标控制器  │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    核心层 (Core)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  基础接口   │  │  数据模型   │  │   工具类    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                 基础设施层 (Infrastructure)              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 数据存储    │  │ 日志系统    │  │ 配置管理    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## 模块说明

### 1. 核心层 (Core)

#### 基础接口 (`core/base.py`)
- `ITrajectoryCollector`: 轨迹收集器接口
- `ITrajectoryGenerator`: 轨迹生成器接口
- `ITrajectoryStorage`: 轨迹存储接口
- `IMouseController`: 鼠标控制器接口
- `BaseComponent`: 所有组件的基类

#### 数据模型
- `TrajectoryPoint`: 轨迹点数据结构
- `Trajectory`: 完整轨迹数据结构

#### 异常类 (`core/exceptions.py`)
- `MouseTrajectoryError`: 基础异常类
- 特定异常类：配置错误、收集错误、生成错误等

### 2. 基础设施层 (Infrastructure)

#### 配置管理 (`config/settings.py`)
- `ConfigManager`: 统一的配置管理器
- 支持环境变量覆盖
- 配置验证机制

#### 日志系统 (`core/logging.py`)
- `LoggerManager`: 日志管理器
- `ErrorHandler`: 错误处理器
- 装饰器：`@error_handler`, `@log_performance`

#### 数据存储 (`core/storage.py`)
- `CSVTrajectoryStorage`: CSV格式存储实现
- `PickleModelStorage`: 模型存储实现
- 支持元数据存储

### 3. 业务逻辑层 (Business)

#### 轨迹收集器
负责收集用户的鼠标轨迹数据

#### 轨迹生成器
使用训练好的模型生成人类风格的轨迹

#### 鼠标控制器
执行鼠标操作，包括移动、点击、拖拽等

### 4. 应用层 (Application)

#### 收集器UI
基于Pygame的图形界面，用于收集轨迹数据

#### 播放器UI
轨迹回放和可视化工具

#### 命令行工具
提供批处理和自动化功能

## 改进点

1. **模块化设计**
   - 清晰的模块边界
   - 通过接口进行交互
   - 易于单元测试

2. **配置管理**
   - 集中式配置
   - 支持多环境配置
   - 运行时配置验证

3. **错误处理**
   - 统一的异常层次
   - 完整的错误日志
   - 优雅的错误恢复

4. **日志系统**
   - 分级日志记录
   - 性能监控
   - 调试信息追踪

5. **数据抽象**
   - 清晰的数据模型
   - 存储层抽象
   - 支持多种存储格式

## 使用示例

```python
from config.settings import config
from core.logging import get_logger
from core.storage import CSVTrajectoryStorage
from business.collector import TrajectoryCollector

# 初始化组件
logger = get_logger(__name__)
storage = CSVTrajectoryStorage(config.trajectory.csv_output_dir)
collector = TrajectoryCollector(storage)

# 收集轨迹
try:
    collector.start_collection((100, 100))
    # ... 收集轨迹点
    trajectory = collector.finish_collection((800, 600))
    logger.info(f"Collected trajectory with {len(trajectory.points)} points")
except Exception as e:
    logger.error(f"Failed to collect trajectory: {e}")
```

## 未来扩展

1. **插件系统**: 支持自定义轨迹生成算法
2. **网络支持**: 远程轨迹收集和控制
3. **数据分析**: 轨迹数据的统计分析功能
4. **AI增强**: 使用深度学习改进轨迹生成